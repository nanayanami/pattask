<%# 投稿一覧押すと、詳細にいくことができる。%>

<div class="posts cover">
  <div class="pd-layout">
    <section class="pd-main">
      <h1 class="posts-title"><%= @post.title %></h1>
      <p class="posts-meta">チーム: <%= @team.name %></p>
      <p class="posts-meta">カテゴリー: <%= @category.name %></p>
      <div class="post-progress-box mb-3">
        <%= render "posts/progress_badge", post: @post %>
        <% unless @post.completed? %>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <% Post.progress_statuses.keys.each do |key| %>
              <% button_class = @post.progress_status == key ? Post::PROGRESS_BUTTON_CLASSES[key.to_sym] : "btn-outline-#{Post::PROGRESS_BUTTON_CLASSES[key.to_sym].delete_prefix('btn-')}" %>
              <%= button_to Post::PROGRESS_LABELS[key.to_sym],
                            update_progress_team_category_post_path(@team, @category, @post, progress_status: key),
                            method: :patch,
                            class: "btn btn-sm #{button_class}" %>
            <% end %>
            <%= button_to "完了にする",
                          complete_team_category_post_path(@team, @category, @post),
                          method: :patch,
                          class: "btn btn-sm btn-complete" %>
          </div>
        <% else %>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <p class="text-muted small mb-0">完了済みのため進捗ボタンは非表示です。</p>
            <%= button_to "進捗に戻す",
                          uncomplete_team_category_post_path(@team, @category, @post),
                          method: :patch,
                          class: "btn btn-sm btn-uncomplete" %>
          </div>
        <% end %>
      </div>

      <% if @post.errors.any? %>
        <div class="card text-center text-white bg-danger mb-3">
          <%= @post.errors.count %>件のエラーが発生しました
          <% @post.errors.full_messages.each do |message| %>
            <%= message %>
          <% end %>
        </div>
      <% end %>

      <h1 class="p-h1 pd-h-main">内容</h1>
      <div class="post-content-box">
        <%= @post.content %>
      </div>

      <p class="caption">
        <% if @post.favorited_by?(current_user) %>
          <%= link_to team_category_post_favorites_path(@team, @category, @post), data: { turbo_method: :delete }, class: "favorite_btn" do %>
            ♥<%= @post.favorites.count %>ブックマーク済
          <% end %>
        <% else %>
          <%= link_to team_category_post_favorites_path(@team, @category, @post), data: { turbo_method: :post }, class: "favorite_btn" do %>
            ♡<%= @post.favorites.count %>ブックマーク
          <% end %>
        <% end %>
      </p>

      <div class="post-head">
        <div class="d-flex gap-2 post-actions">
          <%= link_to "編集する", edit_team_category_post_path(@team, @category, @post),
                      class: "btn btn-success btn-sm btn-edit" %>
          <%= link_to "削除する", team_category_post_path(@team, @category, @post),
                      data: { turbo_method: :delete, turbo_confirm: "本当に消しますか？" },
                      class: "btn btn-danger btn-sm btn-del" %>
        </div>


        <div class="post-back">
          <%= link_to "投稿一覧に戻る", team_category_path(@team, @category),
                      class: "btn btn-dark btn-sm btn-back" %>
        </div>
      </div>
    </section>

    <aside class="pd-comments">
      <h1 class="p-h1 pd-h">コメント</h1>
      <p class="c-count">コメント <%= @post.comments.count %>件</p>

      <% if @comment.errors.any? %>
        <div class="card text-center text-white bg-danger mt-3">
          <%= @comment.errors.count %>件のエラーが発生しました
          <% @comment.errors.full_messages.each do |message| %>
            <%= message %>
          <% end %>
        </div>
      <% end %>

      <%= render "comments/form", team: @team, category: @category, post: @post, comment: @comment %>

      <div class="c-list">
        <% @comments.each do |comment| %>
          <%= render "comments/comment", comment: comment, team: @team, category: @category, post: @post %>
        <% end %>

        <% if @comments.empty? %>
          <p class="c-empty">まだコメントはありません。</p>
        <% end %>
      </div>

      <div class="c-page">
        <%= paginate @comments %>
      </div>
    </aside>
  </div>
</div>